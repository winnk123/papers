ALIGNER_USER_PROMPT = """
    你是一个**OCR残缺文本取证专家**。你的任务是将【标准文本 (GT)】中的题目内容，映射到【待搜索文本 (Pred)】中，圈定出每一道题目的**物理边界**。

    ### 核心矛盾
    GT 是干净的，但 Pred 充满了严重的乱码、公式插入和错别字。
    **任务关键：建立 GT（理想）与 Pred（现实）之间的对应关系，但绝不要修改 Pred 的原文。**
    
    ### ⚠️ 最重要的原则
    **即使部分题目无法匹配，也必须继续对齐其他题目！**
    - 如果GT中第1题无法在Pred中找到对应，**不要放弃**，继续尝试对齐第2、3、4...题
    - 如果GT中某道题标记为`[无法识别]`，**不要放弃**，继续对齐其他题目
    - 即使GT和Pred的第1题内容完全不同，也要尝试对齐后续题目（如第8、9、10...题）
    - **目标**：尽可能多地对齐题目，而不是因为一道题失败就放弃整个文件
    - **返回结果**：必须包含所有能够成功匹配的题目，即使只匹配上了部分题目（如8题中只匹配上了5题），也要返回这5题的对齐结果
    
    ### 🔥 核心原则 (违反必究)
    1. **严格顺序性**：Pred 中的题目顺序必须与 GT 一致。第 N 题的 `pred_start_snippet` 必须出现在 第 N-1 题的 `pred_end_snippet` **之后**。绝不允许回溯或重叠！
    2. **物理截断法**：不要在 Pred 中寻找 GT 的完美结尾。**第 N 题的结尾，就是【第 N+1 题题号/开头】的前面。**
    3. **拒绝修正**：`pred_start_snippet` 和 `pred_end_snippet` 必须**逐字逐句**复制 Pred 中的原文，**保留所有**乱码、错别字、缺失的标点。如果 Pred 是 "求 P G"，绝对不要输出 "求 PG"。
    4. **唯一性**：Snippet 必须足够长（至少 8 个字符），以保证在全文中是唯一的。对于每行一题的格式，可以适当缩短到8-10个字符以提高匹配精度。
    5. **语义相似性匹配**：**优先使用语义理解来判断题目是否匹配**，而不是完全依赖字面匹配：
       - **语义优先**：即使数学表达式不同（如GT是"z = 2/(1+i)"，Pred是"z = 1+i"），如果语义相近（都是关于复数的题目），也应该匹配
       - **主题识别**：通过识别题目的主题、类型、关键概念来判断是否是同一道题
       - **容忍差异**：允许OCR识别错误、公式变形、数值差异，只要核心语义相同就应该匹配
       - **宽松匹配**：不要因为格式差异、标点符号不同、LaTeX公式变形就放弃匹配
    6. **锚点鲁棒性**：选择的锚点应该能够容忍OCR识别错误和文本差异：
       - 优先选择包含题目主题、类型、关键概念的片段（如"复数"、"集合"、"向量"等）
       - 其次选择包含数字、特殊符号或独特词汇的片段
       - 避免选择常见的连接词、标点符号或模糊表达
       - **严禁在snippet中包含状态标签**：不要包含`[格式正常]`、`[条件缺失]`、`[严重污损]`等状态标签。这些标签可能在预处理阶段被移除，会导致匹配失败
       - **锚点长度控制在8-15个字符之间**，既保证唯一性又避免过长。对于每行一题的格式，优先使用8-10个字符的短锚点以提高匹配精度
       - 选择在上下文中具有稳定性的内容，能够容忍轻微的空间、标点变化
       - **特别注意**：避免将数学表达式（如LaTeX公式、分数、根号等）作为锚点，这些内容在OCR识别中容易变形
       - **锚点质量检查**：确保锚点是完整的自然语言片段，而不是公式片段或符号组合
    ### 🔍 搜索策略 (请严格按此步骤思考)
    对于 GT 中的第 N 题：

    **⚠️ 特殊情况：如果 GT 中第 N 题标记为 `[无法识别]` 或 `[无法识别的选择题]` 等：**
    - **GT 标记为无法识别**：说明 GT 本身没有这道题的内容，只有题号和标记。
    - **关键：不要因为这道题无法匹配就放弃后续题目！**
    - **处理方式**：
      1. `gt_start_snippet`: 摘录 GT 中的题号和标记（如 "7. [无法识别的选择题]"）
      2. `gt_end_snippet`: 同样摘录标记（如 "[无法识别的选择题]"）
      3. **Pred 定位**：仍然尝试在 Pred 中根据**题号**或**题目顺序**找到对应的题目内容。
      4. **匹配策略**：
         - **优先使用题号匹配**：在 Pred 中搜索题号（如 "7."），如果找到，提取该题目的内容
         - **如果题号丢失，使用顺序匹配**：如果 Pred 中题号丢失，根据题目顺序匹配（GT 中第 N 题对应 Pred 中第 N 个题目）
      5. 如果 Pred 中找到了对应的题目：
         - `pred_start_snippet`: 摘录 Pred 中该题的实际开头
         - `pred_end_snippet`: 摘录 Pred 中该题的实际结尾
      6. 如果 Pred 中找不到对应的题目（题号不存在且顺序也不匹配）：
         - `pred_start_snippet`: 设置为空字符串 ""
         - `pred_end_snippet`: 设置为空字符串 ""
      7. **重要：即使第 N 题无法匹配，也必须继续对齐第 N+1、N+2...题！**
    - **注意**：即使 GT 标记为无法识别，也要尝试在 Pred 中查找，因为 Pred 可能识别出了 GT 无法识别的内容。
    
    **⚠️ 特殊情况：如果 GT 和 Pred 的第 1 题内容完全不同：**
    - **不要放弃！** 继续尝试对齐后续题目（第2、3、4...题）
    - GT第1题可能是`[无法识别]`，但Pred第1题可能有内容，或者反之
    - 从第2题开始重新尝试匹配，可能后续题目都能对齐成功
    - **示例**：GT有8题（题号7-14），如果题号7无法匹配，继续尝试题号8-14，可能这7题都能成功对齐

    1. **定位【开头】 - ⚠️ 语义相似性匹配**：
       - **GT 参照**：找到 GT 中第 N 题的开头，理解题目的**语义主题**（如"复数"、"集合"、"向量"等）。
       - **Pred 定位**：在 Pred 中寻找**语义相近**的题目开头，匹配策略（按优先级）：
         - **策略1（优先）**：**语义匹配** - 识别题目的主题和类型，即使数学表达式不同，只要语义相近就应该匹配
           - 例如：GT是"若复数 z = 2/(1+i)"，Pred是"若复数 z = 1+i"，虽然表达式不同，但都是关于复数的题目，应该匹配
         - **策略2**：题号匹配 - 如果GT和Pred中都有题号 "N."，使用题号辅助定位
         - **策略3**：关键词匹配 - 如果题号丢失，利用题干前几个关键词定位（如"若复数"、"已知集合"等）
         - **策略4**：顺序匹配 - 如果前几个策略都失败，根据题目顺序匹配（GT中第N题对应Pred中第N个题目）
       - **摘录**：分别摘录 GT 和 Pred 的原话。**即使内容有差异，只要语义相近就应该尝试匹配**。
       - **⚠️ 重要**：在摘录`pred_start_snippet`时，**如果Pred的题目前有状态标签**（如`[格式正常]`、`[条件缺失]`等），**必须跳过这些标签**，从题号或题目内容开始摘录。例如：
         - ❌ 错误：`"pred_start_snippet": "[格式正常]\n\n1. 若椭圆C..."`
         - ✓ 正确：`"pred_start_snippet": "1. 若椭圆C..."`

    2. **定位【结尾】 - ⚠️ 物理截断法**：
      - **GT 参照**：找到 GT 中第 N 题的自然语义结尾（如"...的取值范围。"）。
      - **Pred 定位**：**不要**强行去 Pred 里找 GT 的结尾词！
      - **策略**：请先找到【第 N+1 题】的开头！第 N 题的 Pred 结尾，就是**紧挨在【第 N+1 题开头】之前**的那段文字。
      - **⚠️ 严格边界约束**：
        - `pred_end_snippet` **绝对不能包含下一题的开头**（如题号 "8."、"9." 等）
        - `pred_end_snippet` **绝对不能包含下一题的任何内容**
        - 如果第 N 题有答案标签（如 `【答案：D】`），`pred_end_snippet` 应该**在答案标签之后、下一题开头之前**
        - 如果第 N 题没有答案标签，`pred_end_snippet` 应该在最后一个选项之后、下一题开头之前
        - 如果无法确定边界，宁可截取到更早的位置，也不要包含下一题的开头
      - 即使那是乱码（如 "(9a²)/b"），只要它是第 N 题区域内的最后一段字符，就把它作为 `pred_end_snippet`。

    ### 📝 输出要求
    请返回纯 JSON 列表。包含以下字段：
    - `question_id`: 题目编号，与GT的题目编号一致
    - `gt_start_snippet`: GT 中该题的**标准**开头（用于验证匹配正确性）。
    - `gt_end_snippet`: GT 中该题的**标准**结尾。
    - `pred_start_snippet`: Pred 中该题**实际**起始处的文本（**必须是 Pred 原文**，含错字/缺题号）。
    - `pred_end_snippet`: Pred 中该题**实际**结束处的文本（**必须是 Pred 原文**，**哪怕它是乱码**）。
      - **⚠️ 重要**：`pred_end_snippet` 必须**严格在下一题开头之前**，不能包含任何下一题的内容（包括题号）
      - 如果题目有答案标签，`pred_end_snippet` 应该在答案标签之后
      - 如果题目没有答案标签，`pred_end_snippet` 应该在最后一个选项之后
    - `gt_answer`: GT 中该题的答案（如果存在）。提取规则：
      - 填空题：提取下划线中的内容（如 `___3_____` → `"3"`），空下划线返回 `""`
      - 选择题：提取选项字母组合（如 `ABD`），不要提取问题文本
      - 答案标签：提取 `【答案：X】` 或 `[答案：X]` 中的 `X`
      - **禁止**：不要提取问题文本（如"的值为"、"的坐标为"等）或整个题目内容（包含题号、多个选项标记、长度>50字符）
      - 找不到答案时返回 `""`
    - `pred_answer`: Pred 中该题的答案，提取规则同上
    
    **重要提示**：
    1. **持续对齐**：**即使部分题目无法匹配，也必须继续对齐其他题目**。目标是尽可能多地对齐题目，而不是追求完美匹配。
    2. **语义相似性优先**：**优先使用语义理解来判断题目是否匹配**，不要因为数学表达式不同、数值差异、格式差异就放弃匹配。只要题目的主题、类型、核心概念相同，就应该尝试匹配。
    3. **snippet长度**：至少 8-10 个字符，以确保唯一定位。对于每行一题的格式，优先使用8-10个字符的短锚点以提高匹配精度。但如果使用语义匹配，可以适当缩短snippet长度。
    4. **原样摘录**：Pred 保留乱码和错字，GT 保留标准格式
    5. **答案提取**：只提取实际答案值（数字、字母、短表达式），长度通常<50字符。禁止提取问题文本或整个题目内容
    6. **边界准确性**：
       - `pred_end_snippet` 必须准确标识当前题的结尾，不能包含下一题的任何内容
       - 如果发现 `pred_end_snippet` 包含了下一题的题号或开头，这是**严重错误**，必须修正
       - 答案标签（如 `【答案：X】`）应该在当前题目的范围内，不应该出现在下一题中
    7. **匹配失败处理**：如果某道题实在无法匹配（语义完全不同、题号不存在且顺序也不匹配），可以返回空snippet（`pred_start_snippet` 和 `pred_end_snippet` 都为空字符串 ""），但**必须继续处理后续题目**。
    8. **返回结果完整性**：
       - 必须返回所有GT中的题目（包括无法匹配的题目）
       - 无法匹配的题目也要返回，只是`pred_start_snippet`和`pred_end_snippet`为空字符串
       - **不要**因为第1题无法匹配就返回空列表，**必须**尝试后续所有题目
       - 即使只有部分题目能匹配，也要返回所有题目的对齐结果（能匹配的填写snippet，不能匹配的snippet为空）

    ### 💡 举例 (Few-Shot)
    
    **示例1 - 跳过状态标签**:
    **GT (第1题)**: "1. 若椭圆C：x²/4 + y² = 1上有一点P到两焦点的距离为3..."
    **Pred**: "[格式正常]\n\n1. 若椭圆C：x²/4 + y² = 1上有一点P到两焦点的距离为3..."
    
    **分析**：Pred文本以`[格式正常]`标签开头，但这个标签会在预处理阶段被移除，所以snippet不应该包含它。
    
    **正确输出**:
    [
        {{
            "question_id": "1",
            "gt_start_snippet": "1. 若椭圆C：x²/4 + y² = 1",
            "gt_end_snippet": "距离为 ( )",
            "pred_start_snippet": "1. 若椭圆C：x²/4 + y² = 1",  // ✓ 正确：跳过了[格式正常]标签
            "pred_end_snippet": "距离为 ( )"
        }}
    ]
    
    **❌ 错误示例**:
    {{
        "pred_start_snippet": "[格式正常]\n\n1. 若椭圆C：x²/4 + y² = 1",  // ✗ 错误：包含了状态标签
        ...
    }}
    
    **示例2 - 语义相似但表达式不同**:
    **GT (第1题)**: "1. 若复数 z = 2/(1+i)，则 |z+2|="
    **Pred (第1题)**: "1. 若复数 z = 1 + i，则 |z + 2| ="
    
    **分析**：虽然表达式不同（GT是"z = 2/(1+i)"，Pred是"z = 1+i"），但都是关于复数的题目，语义相近，应该匹配。
    
    **正确输出**:
    [
        {{
            "question_id": "1",
            "gt_start_snippet": "1. 若复数 z = 2/(1+i)",
            "gt_end_snippet": "|z+2|=",
            "pred_start_snippet": "1. 若复数 z = 1 + i", 
            "pred_end_snippet": "|z + 2| ="
        }}
    ]
    
    **示例3 - 题号丢失但语义匹配**:
    **示例3 - 题号丢失但语义匹配**:
    **GT (第18题)**: "18. (12分) ...求 a 的取值范围。"
    **GT (第19题)**: "19. 定义 [m] 为..."
    
    **Pred (高噪)**: 
    "...求 a 的取值范围(乱码) (9a²)/b  <-- 这里的乱码其实是第18题区域的物理结尾
     (17分)定义 m 为...             <-- 这里是第19题的实际开头（题号丢了）"
    
    **正确输出**:
    [
        {{
            "question_id": "18",
            "gt_start_snippet": "18. (12分) 已知函数",
            "gt_end_snippet": "求 a 的取值范围。",
            "pred_start_snippet": "18. (17分) 已知函数", 
            "pred_end_snippet": "(9a²)/b"  // ⚠️ Pred结尾是乱码，但物理位置是对的
        }},
        {{
            "question_id": "19",
            "gt_start_snippet": "19. 定义 [m] 为不大于",
            "gt_end_snippet": "求 n0 的最小值。",
            "pred_start_snippet": "(17分)定义 m 为不大于", // ⚠️ Pred丢失题号，但语义匹配（都是关于定义和最小值）
            "pred_end_snippet": "求 n0 的最小值."
        }}
    ]

    ### 📌 答案提取示例
    - 填空题: `"12. 已知函数 f(x)，则 f(2) 的值为 ___3___。"` → `gt_answer = "3"` ✓ | `"的值为"` ✗
    - 选择题: `"11. 下列选项正确的是 ABD"` → `gt_answer = "ABD"` ✓ | `"下列选项正确的是"` ✗
    - 答案标签: `"13. 计算题...【答案：1/2】"` → `gt_answer = "1/2"` ✓
    - 找不到答案: 返回 `""`，不要提取问题文本或整个题目内容

    ---
    ### 待搜索文本 (Pred - 包含大量噪声):
    {pred_content}

    ---
    ### 标准参考文本 (GT):
    {gt_content}
    """ 

PICTURE_ANALYSIS_PROMPT = """
请比较这两张图片的相似度，只需要返回一个0到1之间的数字，表示相似度分数。
1.0 表示完全相同，0.0 表示完全不同。
只返回数字，不要有其他文字。
"""